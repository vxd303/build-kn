name: 'Pixel 3a Kernel Build - PixelExperience Source'
description: "Builds Pixel 3a kernel using the correct PixelExperience source and branch."
branding:
  icon: 'activity'
  color: 'blue'

inputs:
  # KhÃ´ng cáº§n URL vÃ  branch ná»¯a, chÃºng ta sáº½ cá»‘ Ä‘á»‹nh chÃºng.
  repo-token:
    required: true
  config:
    description: 'The defconfig to use. Should be b1c1_defconfig for this setup.'
    required: true
    default: 'b1c1_defconfig' # Äáº·t máº·c Ä‘á»‹nh lÃ  config cá»§a báº¡n
  arch:
    default: arm64
  aosp-clang-version:
    default: "r383902"
  android-version:
    default: "12"

runs:
  using: 'composite'
  steps:
    - name: 'Setup Environment'
      shell: bash
      run: |
        set -e
        # CÃ¡c lá»‡nh setup giá»¯ nguyÃªn
        SU() { [ "$(id -u)" -eq 0 ] && "$@" || sudo "$@"; }
        echo "::group::Setup Environment"
        if [ -f "/usr/local/bin/brew" ]; then
          aria2c -q https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh && NONINTERACTIVE=1 bash ./uninstall.sh -f -q >/dev/null 2>&1 || true
        fi
        SU rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        SU fallocate -l 16G /swapfile && SU chmod 600 /swapfile && SU mkswap /swapfile && SU swapon /swapfile
        echo "deb [trusted=yes] https://deb.debian.org/debian/ bullseye main contrib non-free" | SU tee -a /etc/apt/sources.list
        SU apt-get update && SU apt-get install --no-install-recommends -y binutils-aarch64-linux-gnu git make bc bison openssl curl zip kmod cpio flex libelf-dev libssl-dev device-tree-compiler ca-certificates python2.7 python3 xz-utils aria2 build-essential
        wget -q https://android.googlesource.com/platform/system/libufdt/+archive/refs/heads/master/utils.tar.gz && tar -xvf utils.tar.gz -C .
        SU cp src/mkdtboimg.py /usr/bin/mkdtimg && SU chmod +x /usr/bin/mkdtimg
        SU ln -sf /usr/bin/python2.7 /usr/bin/python
        echo "::endgroup::"

    - name: '2. Build Kernel Components & Manually Append DTB'
      shell: bash
      run: |
        set -e
        # Táº£i Toolchains Ä‘á»“ng bá»™ cho Android 12
        echo "::group::Downloading SYNCHRONIZED Toolchains for Android 12"
        mkdir -p "$HOME/clang" "$HOME/gcc-64" "$HOME/gcc-32"
        aria2c -x 16 -s 16 -o clang.tar.gz "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12-release/clang-r383902b.tar.gz" && tar -C $HOME/clang -zxf clang.tar.gz && rm clang.tar.gz
        aria2c -x 16 -s 16 -o gcc64.tar.gz "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/android12-release.tar.gz" && tar -C $HOME/gcc-64 -zxf gcc64.tar.gz && rm gcc64.tar.gz
        aria2c -x 16 -s 16 -o gcc32.tar.gz "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/heads/android12-release.tar.gz" && tar -C $HOME/gcc-32 -zxf gcc32.tar.gz && rm gcc32.tar.gz
        export PATH="$HOME/clang/bin:$HOME/gcc-64/bin:$HOME/gcc-32/bin:$PATH"
        echo "::endgroup::"
        
        # Clone Ä‘Ãºng source vÃ  branch
        echo "::group::Cloning PixelExperience Kernel Source"
        git clone --depth=1 "https://github.com/PixelExperience-Devices/kernel_google_msm-4.9.git" -b "twelve" kernel_src
        cd kernel_src
        echo "::endgroup::"
        
        # --- LOGIC BUILD VÃ€ Ná»I FILE CUá»I CÃ™NG ---
        echo "::group::Building Components and Manually Appending DTB"
        mkdir -p out
        ARGS="O=out ARCH=arm64 CROSS_COMPILE=$HOME/gcc-64/bin/aarch64-linux-android- CLANG_TRIPLE=aarch64-linux-gnu- CC=clang"
        
        # 1. Build config
        make -j1 $ARGS b1c1_defconfig
        
        # 2. Build CÃC THÃ€NH PHáº¦N RIÃŠNG Láºº, khÃ´ng pháº£i 'all'
        make -j1 $ARGS Image.lz4 dtbs dtbo.img
        
        # 3. Äi vÃ o thÆ° má»¥c chá»©a káº¿t quáº£
        cd out/arch/arm64/boot/
        
        # 4. XÃ¡c Ä‘á»‹nh file DTB Ä‘Ã£ Ä‘Æ°á»£c biÃªn dá»‹ch cho sargo
        #    Sau khi cháº¡y 'make dtbs', file nÃ y PHáº¢I tá»“n táº¡i
        SARGO_DTB="dts/qcom/sdm670-sargo-idp.dtb"
        
        if [ ! -f "$SARGO_DTB" ]; then
            echo "::error::Critical Failure: '$SARGO_DTB' was not created after 'make dtbs'. The kernel source might be missing files even on this branch."
            ls -lR dts/qcom/
            exit 1
        fi

        # 5. Tá»° TAY Ná»I FILE
        echo "Manually appending '$SARGO_DTB' to Image.lz4..."
        cat Image.lz4 "$SARGO_DTB" > Image.lz4-dtb
        
        # 6. KIá»‚M TRA KÃCH THÆ¯á»šC CUá»I CÃ™NG
        SIZE_FINAL=$(stat -c%s Image.lz4-dtb)
        echo "ðŸ“¦ Final combined image size is: $((SIZE_FINAL / 1024 / 1024)) MB"
        if [ $SIZE_FINAL -lt 17000000 ]; then
            echo "::error::Manual append failed. The size is still too small."
        else
            echo "âœ… SUCCESS! Final image size is correct."
        fi
        cd ../../../../ # Quay láº¡i thÆ° má»¥c kernel_src
        echo "::endgroup::"
        
    - name: '3. Package AnyKernel3 & Upload'
      env:
        ANYKERNEL_SCRIPT: |
          properties() {
          kernel.string=Custom Kernel for Pixel 3a/3a XL by vxd303
          do.devicecheck=1; do.modules=0; do.systemless=1; do.cleanup=1; do.cleanuponabort=0;
          device.name1=sargo; device.name2=bonito; supported.versions=10-13;
          }
          . tools/ak3-core.sh;
          dump_boot;
          kernel_image=$(find . -name "Image.*" | head -n 1);
          if [ -n "$kernel_image" ]; then
            mv -f "$kernel_image" "$split_img/boot.img-kernel";
          else
            ui_print " ! No kernel image found in zip";
            exit 1;
          fi;
          write_boot;
          if [ -f dtbo.img ]; then
            flash_dtbo;
          fi;
      shell: bash
      run: |
        set -e
        echo "::group::Packaging AnyKernel3"
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        
        # Logic sao chÃ©p linh hoáº¡t Ä‘Ã£ Ä‘Æ°á»£c chá»©ng minh
        if [ -f kernel_src/out/arch/arm64/boot/Image.*-dtb ]; then
            cp kernel_src/out/arch/arm64/boot/Image.*-dtb AnyKernel3/ -v
        elif [ -f kernel_src/out/arch/arm64/boot/Image.lz4 ]; then
            cp kernel_src/out/arch/arm64/boot/Image.lz4 AnyKernel3/ -v
        elif [ -f kernel_src/out/arch/arm64/boot/Image.gz ]; then
            cp kernel_src/out/arch/arm64/boot/Image.gz AnyKernel3/ -v
        else
            cp kernel_src/out/arch/arm64/boot/Image AnyKernel3/ -v
        fi
        
        test -f kernel_src/out/arch/arm64/boot/dtbo.img && cp -v kernel_src/out/arch/arm64/boot/dtbo.img AnyKernel3/
        
        echo "$ANYKERNEL_SCRIPT" > AnyKernel3/anykernel.sh
        
        cd AnyKernel3
        zip -r9 "../build-pixel3a-kernel.zip" ./*
        cd ..
        echo "âœ… Flashable zip created."
        echo "::endgroup::"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixel3a-kernel-dtb-fixed
        path: build-pixel3a-kernel.zip

    - name: Build Summary
      shell: bash
      run: |
        echo "## ðŸŽ‰ Pixel 3a Kernel Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Device**: Pixel 3a / 3a XL (sargo/bonito)" >> $GITHUB_STEP_SUMMARY
