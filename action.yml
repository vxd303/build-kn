name: 'Android Kernel Build Action'
description: "Optimized action to build android kernel for Pixel and Samsung."

branding:
  icon: 'activity'
  color: 'blue'

inputs:
  kernel-url:
    description: 'Kernel Source Url'
    required: true
  repo-token:
    description: 'Token'
    required: false
  depth:
    required: false
    default: 1
  kernel-dir:
    required: false
    default: kernel
  kernel-branch:
    description: 'Branch name for kernel source'
    required: true
  config:
    description: 'configuration for building android kernel'
    required: true
    default: defconfig
  arch:
    required: true
    default: arm64
  android-version:
    description: 'Android version.'
    required: false
    default: ""
  ksu:
    description: 'KernelSU support'
    required: false
    default: false
  disable-lto:
    description: 'Disable LTO'
    required: false
    default: false
  ccache:
    required: false
    default: false
  aosp-gcc:
    required: false
    default: false
  aosp-clang:
    required: false
    default: false
  aosp-clang-version:
    required: false
    default: "r383902"
  anykernel3:
    required: false
    default: false
  access-token:
    required: false
  extra-cmd:
    required: false

runs:
  using: 'composite'
  steps:
    - name: Setup ccache
      if: inputs.ccache == 'true'
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ inputs.config }}
        max-size: 4G

    - name: Build Kernel
      shell: bash
      run: |
          set -e
          SU() { [ "$(id -u)" -eq 0 ] && "$@" || sudo "$@"; }

          echo "::group:: Installing Dependencies & Python 2 Fix"
          # Thêm kho lưu trữ cho Python 2 trên Ubuntu mới
          SU apt-get update
          SU apt-get install -y software-properties-common
          SU add-apt-repository -y ppa:deadsnakes/ppa
          SU apt-get update
          
          SU apt-get install --no-install-recommends -y \
            binutils git make bc bison openssl curl zip kmod cpio flex libelf-dev \
            libssl-dev libtfm-dev libc6-dev device-tree-compiler ca-certificates \
            python2.7 python3 xz-utils aria2 build-essential ccache pigz parallel
          
          # Liên kết python2.7 thành python
          SU ln -sf /usr/bin/python2.7 /usr/bin/python
          python --version
          echo "::endgroup::"

          download_and_extract() {
              local url=$1; local name=$2; local dir=$3;
              mkdir -p "$dir"
              aria2c -o "${name}.tar.gz" "$url"
              tar -C "$dir" -xf "${name}.tar.gz"
          }

          if [ "${{ inputs.aosp-clang }}" = "true" ]; then
              echo "::group:: Downloading Clang"
              AOSP_CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android${{ inputs.android-version }}-release/clang-${{ inputs.aosp-clang-version }}.tar.gz"
              [ -z "${{ inputs.android-version }}" ] && AOSP_CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/mirror-goog-main-llvm-toolchain-source/clang-${{ inputs.aosp-clang-version }}.tar.gz"
              download_and_extract "$AOSP_CLANG_URL" "clang" "$HOME/clang"
              export PATH="$HOME/clang/bin:$PATH"
              echo "::endgroup::"
          fi

          if [ "${{ inputs.aosp-gcc }}" = "true" ]; then
              echo "::group:: Downloading GCC"
              G64="https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-12.1.0_r27.tar.gz"
              G32="https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/tags/android-12.1.0_r27.tar.gz"
              download_and_extract "$G64" "gcc64" "$HOME/gcc-64"
              download_and_extract "$G32" "gcc32" "$HOME/gcc-32"
              export PATH="$HOME/gcc-64/bin:$HOME/gcc-32/bin:$PATH"
              echo "::endgroup::"
          fi

          echo "::group:: Pulling Kernel Source"
          git clone --recursive ${{ inputs.kernel-url }} -b "${{ inputs.kernel-branch }}" --depth=${{ inputs.depth }} kernel_src
          echo "::endgroup::"

          cd kernel_src
          
          echo "::group:: Fixing Config Path"
          # Tìm config bất kể vị trí (vendor hay gốc)
          REAL_CONF=$(find arch/${{ inputs.arch }}/configs -name "${{ inputs.config }}" | head -n 1)
          if [ -z "$REAL_CONF" ]; then echo "❌ Config not found!"; exit 1; fi
          cp -f "$REAL_CONF" "arch/${{ inputs.arch }}/configs/${{ inputs.config }}"
          echo "::endgroup::"

          # Thiết lập Compiler
          CMD_CC="clang"; CMD_CROSS="aarch64-linux-android-"; CMD_CROSS32="arm-linux-androideabi-"
          [ "${{ inputs.ccache }}" = "true" ] && CMD_CC="ccache clang"

          COMMON_ARGS="ARCH=${{ inputs.arch }} O=out CROSS_COMPILE=$CMD_CROSS CROSS_COMPILE_ARM32=$CMD_CROSS32 CLANG_TRIPLE=aarch64-linux-gnu- CC=$CMD_CC"

          echo "::group:: Building Kernel"
          mkdir -p out
          # Tách bước config
          make ${COMMON_ARGS} ${{ inputs.config }}
          
          # Build chính thức - Giới hạn j4 để tránh lỗi RAM cho driver Wi-Fi
          make -j4 ${COMMON_ARGS} all ${{ inputs.extra-cmd }} KCFLAGS="-Wno-error" HOSTCFLAGS="-Wno-error"
          echo "::endgroup::"

          if [ "${{ inputs.anykernel3 }}" = "true" ]; then
              echo "::group:: Packaging AnyKernel3"
              git clone https://github.com/osm0sis/AnyKernel3 --depth=1
              rm -rf AnyKernel3/.git
              cp out/arch/${{ inputs.arch }}/boot/Image* AnyKernel3/
              [ -f out/arch/${{ inputs.arch }}/boot/dtbo.img ] && cp out/arch/${{ inputs.arch }}/boot/dtbo.img AnyKernel3/
              cd AnyKernel3 && zip -r ../../build.zip ./*
              echo "::endgroup::"
          fi

    - name: Upload Result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-result
        path: build.zip
