name: 'Android Kernel Build Action - Pixel 3a Fixed'
description: "Complete build with DTB appending for Pixel 3a (sargo) - Fixed boot hang"
branding:
  icon: 'activity'
  color: 'blue'

inputs:
  kernel-url:
    required: true
  repo-token:
    required: true
  kernel-branch:
    required: true
  config:
    required: true
  arch:
    default: arm64
  aosp-clang-version:
    default: "r383902"
  android-version:
    default: "11"
  # Giá»¯ láº¡i input 'anykernel3' Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch, nhÆ°ng máº·c Ä‘á»‹nh lÃ  true
  anykernel3:
    default: "true"

runs:
  using: 'composite'
  steps:
    - name: Cleanup & Setup environment
      shell: bash
      run: |
          set -e
          SU() { [ "$(id -u)" -eq 0 ] && "$@" || sudo "$@"; }
          
          # 1. Gá»¡ Homebrew vÃ  dá»n dáº¹p PATH
          echo "::group::Cleaning Runner"
          aria2c -q https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh
          NONINTERACTIVE=1 bash ./uninstall.sh -f -q >/dev/null 2>&1
          SU rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc
          echo "::endgroup::"

          # 2. Thiáº¿t láº­p Swap
          echo "::group::Setting Up Swap"
          if [ -f /bin/swapon ]; then
              SWAP_FILE=$(swapon --show=NAME | tail -n 1)
              [ ! -z "$SWAP_FILE" ] && SU swapoff "$SWAP_FILE" && SU rm -f "$SWAP_FILE"
              SU fallocate -l 16G /swapfile
              SU chmod 600 /swapfile
              SU mkswap /swapfile
              SU swapon /swapfile
          fi
          echo "::endgroup::"

          # 3. CÃ i Ä‘áº·t dependencies vÃ  mkdtimg
          echo "::group::Installing Dependencies & mkdtimg"
          echo "deb [trusted=yes] https://deb.debian.org/debian/ bullseye main contrib non-free" | SU tee -a /etc/apt/sources.list
          SU apt-get update
          SU apt-get install --no-install-recommends -y binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi git make bc bison openssl curl zip kmod cpio flex libelf-dev libssl-dev libtfm-dev libc6-dev device-tree-compiler ca-certificates python2.7 python3 xz-utils aria2 build-essential ccache parallel
          
          wget -q https://android.googlesource.com/platform/system/libufdt/+archive/refs/heads/master/utils.tar.gz
          mkdir -p dtb-utils && tar -xvf utils.tar.gz -C dtb-utils
          SU cp dtb-utils/src/mkdtboimg.py /usr/bin/mkdtimg
          SU chmod +x /usr/bin/mkdtimg
          SU ln -sf /usr/bin/python2.7 /usr/bin/python
          echo "::endgroup::"

    - name: Build Kernel
      shell: bash
      run: |
        set -e
        download_toolchain() {
            local url=$1; local name=$2; local dir=$3;
            mkdir -p "$dir"
            aria2c -x 16 -s 16 -k 1M -o "${name}.tar.gz" "$url"
            tar -C "$dir" -zxf "${name}.tar.gz"
            rm -f "${name}.tar.gz"
        }
        echo "::group::Downloading Toolchains"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android${{ inputs.android-version }}-release/clang-${{ inputs.aosp-clang-version }}.tar.gz" "clang" "$HOME/clang"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-13.0.0_r0.57.tar.gz" "gcc64" "$HOME/gcc-64"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/tags/android-13.0.0_r0.57.tar.gz" "gcc32" "$HOME/gcc-32"
        
        export PATH="$HOME/clang/bin:$HOME/gcc-64/bin:$HOME/gcc-32/bin:/usr/bin:/bin"
        echo "::endgroup::"

        echo "::group::Cloning Kernel Source"
        KURL=$(echo "${{ inputs.kernel-url }}" | sed 's|https://||')
        git clone --depth=1 "https://x-oauth-basic:${{ inputs.repo-token }}@$KURL" -b "${{ inputs.kernel-branch }}" kernel_src
        echo "::endgroup::"
        
        cd kernel_src
        
        echo "::group::Preparing Config"
        DEST_CONF="arch/${{ inputs.arch }}/configs/${{ inputs.config }}"
        # Táº¯t LTO Ä‘á»ƒ Ä‘áº£m báº£o tÆ°Æ¡ng thÃ­ch
        sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/g' "$DEST_CONF" || true
        sed -i 's/CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/g' "$DEST_CONF" || true
        grep -q "CONFIG_LTO_NONE" "$DEST_CONF" || echo "CONFIG_LTO_NONE=y" >> "$DEST_CONF"
        echo "::endgroup::"

        echo "::group::Compiling Kernel"
        mkdir -p out
        ARGS="ARCH=${{ inputs.arch }} O=out CROSS_COMPILE=$HOME/gcc-64/bin/aarch64-linux-android- CROSS_COMPILE_ARM32=$HOME/gcc-32/bin/arm-linux-androideabi- CLANG_TRIPLE=aarch64-linux-gnu- CC=clang MKDTIMG=mkdtimg LLVM=1 LLVM_IAS=1"
        
        make $ARGS ${{ inputs.config }}
        
        # <--- FIX 1: BUILD TOÃ€N Bá»˜ ARTIFACT Cáº¦N THIáº¾T ---
        # Build táº¥t cáº£ cÃ¡c target cáº§n thiáº¿t cÃ¹ng lÃºc: Image.lz4-dtb vÃ  dtbo.img
        # Makefile sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ viá»‡c ná»‘i Ä‘Ãºng DTB.
        echo "Building kernel images..."
        if ! make -j$(nproc) $ARGS Image.lz4-dtb dtbo.img; then
            echo "::error::Failed to build Image.lz4-dtb and/or dtbo.img. Check your kernel source and config."
            exit 1
        fi
        
        echo "âœ… Kernel artifacts built successfully."
        echo "::endgroup::"

        # <--- FIX 2: LOáº I Bá»Ž HOÃ€N TOÃ€N LOGIC Ná»I DTB THá»¦ CÃ”NG ---
        # KhÃ´ng cáº§n bÆ°á»›c "Post-Build Processing" ná»¯a vÃ¬ 'make' Ä‘Ã£ lÃ m Ä‘Ãºng viá»‡c.
        # CÃ¡c file káº¿t quáº£ Ä‘Ã£ náº±m trong 'out/arch/arm64/boot/' vÃ  sáºµn sÃ ng Ä‘á»ƒ Ä‘Ã³ng gÃ³i.

    - name: Packaging AnyKernel3
      shell: bash
      run: |
        set -e
        KERNEL_OUT="kernel_src/out/arch/${{ inputs.arch }}/boot"
        ZIP_OUT="build-pixel3a-kernel.zip"
        
        echo "::group::Clone AnyKernel3"
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3
        echo "::endgroup::"
        
        # <--- FIX 3: Sá»¬ Dá»¤NG LOGIC ÄÃ“NG GÃ“I ROBUST Tá»ª ACTION THÃ€NH CÃ”NG ---
        echo "::group::Copying kernel files"
        
        # Æ¯u tiÃªn tÃ¬m file kernel Ä‘Ã£ Ä‘Æ°á»£c ná»‘i DTB (Image.*-dtb)
        KERNEL_IMAGE_DTB=$(find "$KERNEL_OUT" -name "Image.*-dtb" | head -n 1)

        if [ -n "$KERNEL_IMAGE_DTB" ]; then
            cp "$KERNEL_IMAGE_DTB" AnyKernel3/
            KERNEL_NAME=$(basename "$KERNEL_IMAGE_DTB")
            SIZE=$(stat -c%s "$KERNEL_IMAGE_DTB")
            echo "âœ… Using '$KERNEL_NAME' ($((SIZE / 1024 / 1024))MB)"
        else
            # Náº¿u khÃ´ng tÃ¬m tháº¥y, bÃ¡o lá»—i vÃ¬ Ä‘Ã¢y lÃ  Ä‘iá»u kiá»‡n tiÃªn quyáº¿t
            echo "âŒ Critical Error: No kernel image with appended DTB (Image.*-dtb) was found!"
            echo "Listing available files in $KERNEL_OUT:"
            ls -lah "$KERNEL_OUT/"
            exit 1
        fi
        
        # Sao chÃ©p DTBO image
        if [ -f "$KERNEL_OUT/dtbo.img" ]; then
            cp "$KERNEL_OUT/dtbo.img" AnyKernel3/
            echo "âœ… DTBO image (dtbo.img) copied."
        else
            echo "âš ï¸ Warning: dtbo.img not found. This might be acceptable for some devices but can cause boot issues on others."
        fi
        
        echo "::endgroup::"

        echo "::group::Configuring AnyKernel3 for Pixel 3a"
        # Sá»­ dá»¥ng anykernel.sh tÃ¹y chá»‰nh cho Pixel 3a (sargo/bonito)
        cat > AnyKernel3/anykernel.sh <<'EOAKS'
# AnyKernel3 Ramdisk Mod Script
# osm0sis @ xda-developers

properties() {
kernel.string=Custom Kernel for Pixel 3a/3a XL by GitHub Actions
do.devicecheck=1
do.modules=0
do.systemless=1
do.cleanup=1
do.cleanuponabort=0
device.name1=sargo
device.name2=bonito
supported.versions=10-13
}

# shell variables
. tools/ak3-core.sh;

dump_boot;

# logic to find kernel image name inside the zip
kernel_image=$(find . -name "Image.*-dtb" | head -n 1);

if [ -f "$kernel_image" ]; then
  # Di chuyá»ƒn kernel Ä‘Ã£ Ä‘Æ°á»£c ná»‘i DTB vÃ o Ä‘Ãºng vá»‹ trÃ­
  mv -f "$kernel_image" "$split_img/boot.img-kernel";
else
  # Fallback náº¿u tÃªn file khÃ¡c, máº·c dÃ¹ logic trÆ°á»›c Ä‘Ã³ Ä‘Ã£ báº¯t lá»—i
  ui_print "  ! No kernel image found in zip";
  exit 1;
fi;

write_boot;
flash_dtbo;
## end install
EOAKS
        chmod +x AnyKernel3/anykernel.sh
        echo "::endgroup::"

        echo "::group::Creating flashable ZIP"
        cd AnyKernel3
        zip -r9 "../$ZIP_OUT" ./*
        cd ..
        
        FINAL_SIZE=$(stat -c%s "$ZIP_OUT")
        echo "âœ… Flashable zip created: $ZIP_OUT"
        echo "ðŸ“¦ Size: $((FINAL_SIZE / 1024 / 1024))MB"
        echo "::endgroup::"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixel3a-kernel-dtb-fixed
        path: build-pixel3a-kernel.zip

    - name: Build Summary
      shell: bash
      run: |
        echo "## ðŸŽ‰ Pixel 3a Kernel Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
        
        KERNEL_IMAGE_PATH=$(find kernel_src/out/arch/arm64/boot -name "Image.*-dtb" | head -n 1)
        if [ -n "$KERNEL_IMAGE_PATH" ]; then
            SIZE=$(stat -c%s "$KERNEL_IMAGE_PATH")
            NAME=$(basename "$KERNEL_IMAGE_PATH")
            echo "- **Kernel Image**: \`$NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: $((SIZE / 1024 / 1024))MB" >> $GITHUB_STEP_SUMMARY
            if [ $SIZE -ge 17000000 ]; then
                echo "- **Status**: âœ… DTB appears to be correctly included (size is normal)." >> $GITHUB_STEP_SUMMARY
            else
                echo "- **Status**: âš ï¸ Final image size is small. Please double-check." >> $GITHUB_STEP_SUMMARY
            fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Flash Instructions" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the \`pixel3a-kernel-dtb-fixed\` artifact." >> $GITHUB_STEP_SUMMARY
        echo "2. Boot into a custom recovery (like TWRP)." >> $GITHUB_STEP_SUMMARY
        echo "3. Flash the \`build-pixel3a-kernel.zip\` file." >> $GITHUB_STEP_SUMMARY
        echo "4. Reboot system." >> $GITHUB_STEP_SUMMARY
