name: 'Android Kernel Build Action - Pixel 3a Fixed (Definitive v2)'
description: "Correctly finds DTS source, compiles, and appends the full DTB for Pixel 3a."
branding:
  icon: 'activity'
  color: 'blue'

inputs:
  kernel-url:
    required: true
  repo-token:
    required: true
  kernel-branch:
    required: true
  config:
    required: true
  arch:
    default: arm64
  aosp-clang-version:
    default: "r383902"
  android-version:
    default: "11"

runs:
  using: 'composite'
  steps:
    - name: 'Setup Environment'
      shell: bash
      run: |
        set -e
        # CÃ¡c lá»‡nh setup giá»¯ nguyÃªn
        SU() { [ "$(id -u)" -eq 0 ] && "$@" || sudo "$@"; }
        echo "::group::Setup Environment"
        if [ -f "/usr/local/bin/brew" ]; then
          aria2c -q https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh && NONINTERACTIVE=1 bash ./uninstall.sh -f -q >/dev/null 2>&1 || true
        fi
        SU rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        SU fallocate -l 16G /swapfile && SU chmod 600 /swapfile && SU mkswap /swapfile && SU swapon /swapfile
        echo "deb [trusted=yes] https://deb.debian.org/debian/ bullseye main contrib non-free" | SU tee -a /etc/apt/sources.list
        SU apt-get update && SU apt-get install --no-install-recommends -y binutils-aarch64-linux-gnu git make bc bison openssl curl zip kmod cpio flex libelf-dev libssl-dev device-tree-compiler ca-certificates python2.7 python3 xz-utils aria2 build-essential
        wget -q https://android.googlesource.com/platform/system/libufdt/+archive/refs/heads/master/utils.tar.gz && tar -xvf utils.tar.gz -C .
        SU cp src/mkdtboimg.py /usr/bin/mkdtimg && SU chmod +x /usr/bin/mkdtimg
        SU ln -sf /usr/bin/python2.7 /usr/bin/python
        echo "::endgroup::"

    - name: 'Build Kernel & Correctly Append DTB'
      shell: bash
      run: |
        set -e
        # Download toolchains
        download_toolchain() {
            aria2c -x 16 -s 16 -k 1M -d "$2" -o "$(basename $1)" "$1" && tar -C "$2" -xf "$2/$(basename $1)" && rm -f "$2/$(basename $1)"
        }
        echo "::group::Downloading Toolchains"
        mkdir -p "$HOME/clang" "$HOME/gcc-64" "$HOME/gcc-32"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android${{ inputs.android-version }}-release/clang-${{ inputs.aosp-clang-version }}.tar.gz" "$HOME/clang"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-13.0.0_r0.57.tar.gz" "$HOME/gcc-64"
        download_toolchain "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/tags/android-13.0.0_r0.57.tar.gz" "$HOME/gcc-32"
        export PATH="$HOME/clang/bin:$HOME/gcc-64/bin:$HOME/gcc-32/bin:/usr/bin:/bin"
        echo "::endgroup::"

        # Clone source
        echo "::group::Cloning Kernel Source"
        KURL=$(echo "${{ inputs.kernel-url }}" | sed 's|https://||')
        git clone --depth=1 "https://x-oauth-basic:${{ inputs.repo-token }}@$KURL" -b "${{ inputs.kernel-branch }}" kernel_src
        cd kernel_src
        echo "::endgroup::"

        # Prepare config
        echo "::group::Preparing Config"
        DEST_CONF="arch/${{ inputs.arch }}/configs/${{ inputs.config }}"
        sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/g' "$DEST_CONF" || true
        sed -i 's/CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/g' "$DEST_CONF" || true
        grep -q "CONFIG_LTO_NONE" "$DEST_CONF" || echo "CONFIG_LTO_NONE=y" >> "$DEST_CONF"
        echo "::endgroup::"

        # --- PHáº¦N Sá»¬A Lá»–I LOGIC ---
        echo "::group::Compiling and Appending DTB from Source Root"
        mkdir -p out
        ARGS="ARCH=${{ inputs.arch }} O=out CROSS_COMPILE=$HOME/gcc-64/bin/aarch64-linux-android- CROSS_COMPILE_ARM32=$HOME/gcc-32/bin/arm-linux-androideabi- CLANG_TRIPLE=aarch64-linux-gnu- CC=clang"
        
        # 1. Build kernel vÃ  dtbs riÃªng biá»‡t. ChÃºng ta Ä‘ang á»Ÿ thÆ° má»¥c kernel_src
        make $ARGS ${{ inputs.config }}
        make -j$(nproc) $ARGS Image.lz4 dtbs dtbo.img

        # 2. XÃ¡c Ä‘á»‹nh cÃ¡c Ä‘Æ°á»ng dáº«n. Táº¤T Cáº¢ Ä‘á»u Ä‘Æ°á»£c tÃ­nh tá»« thÆ° má»¥c hiá»‡n táº¡i (kernel_src)
        DTS_SOURCE_PATH="arch/arm64/boot/dts/qcom/sdm670-sargo-idp.dts"
        DTC_INCLUDE_PATH="arch/arm64/boot/dts" # ÄÆ°á»ng dáº«n Ä‘á»ƒ dtc tÃ¬m cÃ¡c file #include
        COMPILED_DTB_PATH="out/custom-sargo.dtb" # NÆ¡i lÆ°u file .dtb Ä‘Ã£ biÃªn dá»‹ch
        KERNEL_IMAGE_PATH="out/arch/arm64/boot/Image.lz4"
        FINAL_IMAGE_PATH="out/arch/arm64/boot/Image.lz4-dtb"

        # 3. Kiá»ƒm tra file .dts nguá»“n cÃ³ tá»“n táº¡i hay khÃ´ng TRÆ¯á»šC KHI lÃ m gÃ¬ khÃ¡c
        if [ ! -f "$DTS_SOURCE_PATH" ]; then
            echo "::error::Critical: The main DTS source file ($DTS_SOURCE_PATH) was not found in the kernel source."
            echo "Listing contents of arch/arm64/boot/dts/qcom/ to help debug:"
            ls -l arch/arm64/boot/dts/qcom/
            exit 1
        fi
        
        # 4. DÃ¹ng `dtc` Ä‘á»ƒ biÃªn dá»‹ch .dts thÃ nh .dtb
        echo "Compiling full DTB from $DTS_SOURCE_PATH using 'dtc'..."
        dtc -@ -I "$DTC_INCLUDE_PATH" -O dtb -o "$COMPILED_DTB_PATH" "$DTS_SOURCE_PATH"
        
        # 5. Ná»‘i kernel vá»›i file DTB vá»«a biÃªn dá»‹ch
        echo "Appending custom-compiled DTB to kernel..."
        cat "$KERNEL_IMAGE_PATH" "$COMPILED_DTB_PATH" > "$FINAL_IMAGE_PATH"

        # 6. Kiá»ƒm tra kÃ­ch thÆ°á»›c láº§n cuá»‘i
        SIZE_FINAL=$(stat -c%s "$FINAL_IMAGE_PATH")
        echo "ðŸ“¦ Final image size (Image.lz4-dtb): $((SIZE_FINAL / 1024 / 1024)) MB"

        if [ $SIZE_FINAL -lt 17000000 ]; then
            echo "::warning::Final image size is still smaller than expected. Check kernel source config."
        else
            echo "âœ… Final image size looks correct (>= 17MB)."
        fi
        echo "::endgroup::"
        
    - name: Packaging AnyKernel3
      # BÆ°á»›c nÃ y vÃ  cÃ¡c bÆ°á»›c sau giá»¯ nguyÃªn y há»‡t phiÃªn báº£n trÆ°á»›c, khÃ´ng cáº§n thay Ä‘á»•i
      env:
        ANYKERNEL_SCRIPT: |
          # AnyKernel3 Ramdisk Mod Script
          # osm0sis @ xda-developers
          properties() {
          kernel.string=Custom Kernel for Pixel 3a/3a XL by GitHub Actions
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          do.cleanuponabort=0
          device.name1=sargo
          device.name2=bonito
          supported.versions=10-13
          }
          # shell variables
          . tools/ak3-core.sh;
          dump_boot;
          if [ -f Image.lz4-dtb ]; then
            mv -f Image.lz4-dtb "$split_img/boot.img-kernel";
          else
            ui_print " ! Kernel image (Image.lz4-dtb) not found in zip";
            exit 1;
          fi;
          write_boot;
          if [ -f dtbo.img ]; then
            flash_dtbo;
          fi;
      shell: bash
      run: |
        set -e
        # ChÃº Ã½: Ä‘Æ°á»ng dáº«n KERNEL_OUT pháº£i Ä‘Æ°á»£c tÃ­nh tá»« thÆ° má»¥c gá»‘c cá»§a workspace
        KERNEL_OUT="kernel_src/out/arch/${{ inputs.arch }}/boot"
        ZIP_OUT="build-pixel3a-kernel.zip"
        
        echo "::group::Clone AnyKernel3"
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3
        echo "::endgroup::"
        
        echo "::group::Copying kernel files"
        if [ -f "$KERNEL_OUT/Image.lz4-dtb" ]; then
            cp "$KERNEL_OUT/Image.lz4-dtb" AnyKernel3/Image.lz4-dtb
            echo "âœ… Using Image.lz4-dtb"
        else
            echo "âŒ Critical Error: Final Image.lz4-dtb not found after build!"
            ls -lah "$KERNEL_OUT/"
            exit 1
        fi
        
        if [ -f "$KERNEL_OUT/dtbo.img" ]; then
            cp "$KERNEL_OUT/dtbo.img" AnyKernel3/
            echo "âœ… dtbo.img copied."
        else
            echo "âš ï¸ Warning: dtbo.img not found."
        fi
        echo "::endgroup::"
        
        echo "::group::Configuring AnyKernel3"
        echo "$ANYKERNEL_SCRIPT" > AnyKernel3/anykernel.sh
        chmod +x AnyKernel3/anykernel.sh
        echo "::endgroup::"
        
        echo "::group::Creating flashable ZIP"
        cd AnyKernel3
        zip -r9 "../$ZIP_OUT" ./*
        cd ..
        echo "âœ… Flashable zip created: $ZIP_OUT"
        echo "::endgroup::"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixel3a-kernel-dtb-fixed
        path: build-pixel3a-kernel.zip

    - name: Build Summary
      shell: bash
      run: |
        echo "## ðŸŽ‰ Pixel 3a Kernel Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Device**: Pixel 3a / 3a XL (sargo/bonito)" >> $GITHUB_STEP_SUMMARY
